// Generated by CoffeeScript 1.6.3
var AssetManager;

AssetManager = (function() {
  function AssetManager() {
    this.imagesPrefix = 'images/';
    this.tilemapsPrefix = 'levels/';
    this.audiosPrefix = 'audio/';
    this.imagesToLoad = [];
    this.tilemapsToLoad = [];
    this.audiosToLoad = [];
    this.assets = {};
    this.remaining = 0;
  }

  AssetManager.prototype.loadImage = function(url) {
    return this.imagesToLoad.push(url);
  };

  AssetManager.prototype.loadTilemap = function(url) {
    return this.tilemapsToLoad.push(url);
  };

  AssetManager.prototype.loadAudio = function(url) {
    return this.audiosToLoad.push(url);
  };

  AssetManager.prototype.start = function(callback) {
    var audio, audioUrl, img, imgUrl, tilemapUrl, _fn, _i, _j, _k, _len, _len1, _len2, _ref, _ref1, _ref2, _results,
      _this = this;
    _ref = this.tilemapsToLoad;
    _fn = function(tilemapUrl) {
      var xhr;
      xhr = new XMLHttpRequest();
      xhr.open('GET', _this.tilemapsPrefix + tilemapUrl, true);
      xhr.url = tilemapUrl;
      _this.remaining++;
      xhr.onreadystatechange = function() {
        if (xhr.readyState === 4) {
          _this.assets[xhr.url] = JSON.parse(xhr.response);
          _this.remaining--;
          if (_this.remaining === 0) {
            return callback();
          }
        }
      };
      return xhr.send();
    };
    for (_i = 0, _len = _ref.length; _i < _len; _i++) {
      tilemapUrl = _ref[_i];
      _fn(tilemapUrl);
    }
    _ref1 = this.imagesToLoad;
    for (_j = 0, _len1 = _ref1.length; _j < _len1; _j++) {
      imgUrl = _ref1[_j];
      img = new Image();
      img.src = this.imagesPrefix + imgUrl;
      this.remaining++;
      img.onload = function() {
        console.log('loaded image');
        _this.remaining--;
        if (_this.remaining === 0) {
          return callback();
        }
      };
      this.assets[imgUrl] = img;
    }
    _ref2 = this.audiosToLoad;
    _results = [];
    for (_k = 0, _len2 = _ref2.length; _k < _len2; _k++) {
      audioUrl = _ref2[_k];
      audio = new Audio();
      audio.addEventListener('canplaythrough', (function() {
        console.log('loaded audio');
        _this.remaining--;
        if (_this.remaining === 0) {
          return callback();
        }
      }), false);
      audio.src = this.audiosPrefix + audioUrl;
      this.remaining++;
      _results.push(this.assets[audioUrl] = audio);
    }
    return _results;
  };

  return AssetManager;

})();
